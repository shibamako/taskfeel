

<h1>Tasks</h1>

<div>
<%= link_to t('.new', :default => t("helpers.links.new")),
            new_task_path,
            :class => 'btn btn-primary btn-lg' %>
</div>
<hr>

<button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
    検索画面　表示/非表示
  </button>
<p></p>
<div class="collapse" id="collapseExample">

<div class="card border-primary mb-3" style="max-width:100rem;">
  <div class="card-header">Task検索</div>
  <div class="card-body">

<%= search_form_for @q do |f| %>
<div class="row">
  <div class="col-1" align="right"><%= f.label :title %></div>
  <div class="col-6"><%= f.text_field :title_cont, :class => "form-control" %></div>
</div>
<br>
<div class="row">
  <div class="col-1" align="right"><%= f.label :appointed %></div>
  <div class="col-2"><%= f.date_field :appointed_gteq, :class => "form-control" %></div>
  <div class="col-2"><%= f.date_field :appointed_lteq, :class => "form-control" %></div>
</div>
<br>
<div class="row">
  <div class="col-1" align="right"><%= f.label :username %></div>
  <div class="col-2"><%= f.select :username_eq, options_from_collection_for_select(User.where(is_deleted: true), :id, :name), {include_blank: true}, {:class => "form-control"} %></div>
</div>
<br>
<div class="row">
  <div class="col-1" align="right"><%= f.label :category %></div>
  <div class="col-2"><%= f.select :category_eq, options_from_collection_for_select(Category.where(mukou: true).order(:serialize), :id, :category_item), {include_blank: true}, {:class => "form-control"} %></div>
</div>
<br>
<div class="row">
  <div class="col-1" align="right"><%= f.label :status %></div>
  <div class="col-2"><%= f.select :status_eq, options_from_collection_for_select(Status.where(mukou: true).order(:serialize), :id, :status_item), {include_blank: true}, {:class => "form-control"} %></div>
</div>
<br>
<div class="row">
  <div class="col-1"></div>
<div class="col-2">
  <%= f.submit "検索", class: "form-control btn btn-primary submit_btn" %>
</div>
</div>
<% end %>

</div>
</div>
</div>

<table class="table table-bordered table-striped table-hover table-condensed">
  <thead>
    <tr>
      <th>詳細</th>
      <th>期日までの日数</th>
      <th><%= sort_link(@q, :appointed, "期日") %></th>
      <th><%= sort_link(@q, :priority, "優先度") %></th>
      <th><%= sort_link(@q, :username, "ユーザー") %></th>
      <th><%= sort_link(@q, :title, "タイトル") %></th>
      <th><%= sort_link(@q, :category, "カテゴリー") %></th>
      <th><%= sort_link(@q, :status, "ステータス") %></th>
      <th colspan="2"></th>
    </tr>
  </thead>

<%= @q.result.count %> / <%= Task.count %> （ヒット件数/全件数）
<%= paginate(@tasks) %>

  <tbody>
    <% @tasks.each do |task| %>
      <tr>
        <td><%= link_to t('.show', :default => t("helpers.links.show")),
                task_path(task), :class => 'btn btn-info btn-xs' %></td>
        <% if task.status == "3" %>
        <td>完了</td>
        <% elsif date_delay(task.appointed) == "0日" %>
        <td>本日</td>
        <% elsif (task.appointed - Time.now).to_i < 0 %>
        <td><font color="red">期限を<%= date_delay(task.appointed) %>過ぎています</font></td>
        <% else %>
        <td><%= date_today(task.appointed) %>後</td>
        <% end %>
        <td><%= task.appointed.strftime("%Y-%m-%d") %></td>
        <td><%= Priority.find(task.priority).priority_item %></td>
        <td><%= User.find(task.username).name %></td>
        <td><%= task.title %></td>
        <td><%= Category.find(task.category).category_item %></td>
        <% if task.status == "3" %>
        <td><span class="badge rounded-pill bg-primary"><%= Status.find(task.status).status_item %></span></td>
        <% elsif task.status == "1" %>
        <td><span class="badge rounded-pill bg-warning text-dark"><%= Status.find(task.status).status_item %></span></td>
        <% else %>
        <td><span class="badge rounded-pill bg-secondary"><%= Status.find(task.status).status_item %></span></td>
        <% end %>
        <td><%= link_to t('.edit', :default => t("helpers.links.edit")),
                      edit_task_path(task), :class => 'btn btn-secondary btn-xs' %></td>
        <td><%= link_to t('.destroy', :default => t("helpers.links.destroy")),
                      task_path(task),
                      :method => :delete,
                      :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) },
                      :class => 'btn btn-xs btn-danger' %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= month_calendar events: @taskall do |date, tasks| %>
  <%= date.day %>
  <% tasks.each do |task| %>
      <div>
        <% if task.status == "3" %>
        <span class="badge rounded-pill bg-primary"><%= Status.find(task.status).status_item %></span>
        <% elsif task.status == "1" %>
        <span class="badge rounded-pill bg-warning text-dark"><%= Status.find(task.status).status_item %></span>
        <% else %>
        <span class="badge rounded-pill bg-secondary"><%= Status.find(task.status).status_item %></span>
        <% end %>
        <%= link_to task.title, task %>
        （<%= User.find(task.username).name %>）
      </div>
    <% end %>
<% end %>
